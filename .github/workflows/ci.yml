name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  cpp-build-test:
    name: C++ Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure and build
        run: |
          cd reicore
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_PYTHON_MODULE=OFF \
            -DBUILD_TESTS=ON \
            -DBUILD_BENCHMARK=OFF \
            -DBUILD_EXAMPLES=OFF
          cmake --build . --config Release

      - name: Run tests
        run: |
          cd reicore/build
          ctest --output-on-failure

  python-build:
    name: Python wheel (pybind11)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pybind11 scikit-build-core

      - name: Build Python module
        run: |
          cd reicore
          pip install --no-build-isolation -e .

      - name: Quick Python test
        run: |
          python -c "
          from reicore import rei_sort, __version__
          assert __version__ == '2.0.0'
          arr = [3, 1, 4, 1, 5]
          rei_sort(arr)
          assert arr == [1, 1, 3, 4, 5]
          print('reicore OK')
          "
